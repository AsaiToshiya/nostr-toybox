<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>menu</title>
  </head>
  <body>
    <div id="headingAndUsage" style="display: none">
      <h1>menu</h1>
      <p>
        usage:
        <code
          >https://asaitoshiya.github.io/nostr-toybox/menu/?nevent=&lt;nip-19-nevent&gt;</code
        >
      </p>
    </div>
    <div id="content">
      <p><a id="njump">njump.me</a></p>
      <p><a id="njumpRoot">njump.me (root)</a></p>
      <p><a id="replies">Replies</a></p>
      <p><a id="reply">reply</a></p>
      <p><a id="quoteReply">quote reply</a></p>
      <p><a id="bookmark">bookmark</a></p>
      <p><a id="share">share</a></p>
      <p><a id="deleteEvent">delete</a></p>
      <p><a id="pin">pin</a></p>
      <p>
        <button id="copyContent" disabled onclick="handleCopyContentClick()">
          copy content
        </button>
        <span id="copiedContent" style="display: none">copied!</span>
      </p>
      <p>
        <button onclick="handleCopyNip19Click()">copy NIP-19</button>
        <span id="copiedNip19" style="display: none">copied!</span>
      </p>
      <p>
        <button onclick="handleCopyNip21Click()">copy NIP-21</button>
        <span id="copiedNip21" style="display: none">copied!</span>
      </p>
      <p>event:</p>
      <pre id="event"></pre>
    </div>

    <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
    <script type="module">
      const relays = [
        "wss://nos.lol",
        "wss://nostr.bitcoiner.social",
        "wss://nostr.mom",
        "wss://relay.damus.io",
        "wss://relay.nostr.bg",
      ];

      const copy = (text, copiedElementId) =>
        navigator.clipboard.writeText(text).then(() => {
          const style = document.getElementById(copiedElementId).style;
          style.display = "inline";
          setTimeout(() => (style.display = "none"), 3000);
        });

      const handleCopyContentClick = () => copy(event.content, "copiedContent");

      const handleCopyNip19Click = () => copy(nip19, "copiedNip19");

      const handleCopyNip21Click = () => copy(`nostr:${nip19}`, "copiedNip21");

      window.handleCopyContentClick = handleCopyContentClick;
      window.handleCopyNip19Click = handleCopyNip19Click;
      window.handleCopyNip21Click = handleCopyNip21Click;

      const nip19 = new URLSearchParams(location.search).get("nevent");
      !nip19 && (headingAndUsage.style.display = "block");
      !nip19 && (content.style.display = "none");
      const data = window.NostrTools.nip19.decode(nip19).data;
      const id = window.NostrTools.nip19.NostrTypeGuard.isNEvent(nip19)
        ? data.id
        : await (async () => {
            const pool = new window.NostrTools.SimplePool();
            const event = await pool.get(relays, {
              kinds: [data.kind],
              authors: [data.pubkey],
              "#d": [data.identifier],
            });
            pool.close(relays);
            return event.id;
          })();
      const nevent = window.NostrTools.nip19.NostrTypeGuard.isNEvent(nip19)
        ? nip19
        : window.NostrTools.nip19.neventEncode({ id });

      (async () => {
        const pool = new window.NostrTools.SimplePool();
        event = await pool.get(relays, {
          ids: [id],
        });
        pool.close(relays);

        const root = event.tags.find(
          (tag) => tag[0] == "e" && tag[3] == "root"
        );
        root &&
          (njumpRoot.href = `https://njump.me/${window.NostrTools.nip19.neventEncode(
            { id: root[1] }
          )}`);
        deleteEvent.href = `https://asaitoshiya.github.io/nostr-toybox/event/?kind=5&e=${id}&k=${event.kind}`;
        copyContent.disabled = false;
        document.querySelector("#event").innerText = JSON.stringify(
          event,
          null,
          2
        );
      })();

      njump.href = `https://njump.me/${nip19}`;
      replies.href = `https://replies.nostrapps.org/?id=${nip19}`;
      reply.href = `https://asaitoshiya.github.io/nostr-toybox/poster/?nip19=${nevent}`;
      quoteReply.href =
        "https://asaitoshiya.github.io/nostr-toybox/poster/?content=" +
        encodeURIComponent(`

nostr:${nip19}`);
      bookmark.href = `https://asaitoshiya.github.io/nostr-toybox/bookmark/?nevent=${nevent}`;
      share.href = `https://asaitoshiya.github.io/nostr-toybox/note-to-text/?nevent=${nevent}`;
      pin.href = `https://asaitoshiya.github.io/nostr-toybox/pin-list/?nevent=${nevent}`;
    </script>
  </body>
</html>
